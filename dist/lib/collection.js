"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.Collection=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_db=require("./db"),Collection=function(){function a(b){var c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];(0,_classCallCheck2["default"])(this,a),this.collectionName=b,this.schema=c,c&&this.schema.extend({_id:{type:String}}),this._before={},this._after={}}return(0,_createClass2["default"])(a,[{key:"find",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c,d,e=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b=0<e.length&&void 0!==e[0]?e[0]:{},c=1<e.length&&void 0!==e[1]?e[1]:{},this.db){a.next=6;break}return a.next=5,(0,_db.getDB)();case 5:this.db=a.sent;case 6:return this._runBeforeHook("find",b,c),a.next=9,this.db.collection(this.collectionName).find(b,c);case 9:return d=a.sent,this._runAfterHook("find",d),a.abrupt("return",d);case 12:case"end":return a.stop();}},a,this)}));return function find(){return a.apply(this,arguments)}}()},{key:"findOne",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c,d,e=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b=0<e.length&&void 0!==e[0]?e[0]:{},c=1<e.length&&void 0!==e[1]?e[1]:{},this.db){a.next=6;break}return a.next=5,(0,_db.getDB)();case 5:this.db=a.sent;case 6:return this._runBeforeHook("findOne",b,c),a.next=9,this.db.collection(this.collectionName).findOne(b);case 9:return d=a.sent,this._runAfterHook("findOne",d),a.abrupt("return",d);case 12:case"end":return a.stop();}},a,this)}));return function findOne(){return a.apply(this,arguments)}}()},{key:"updateOne",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e,f,g,h,i,j=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=2<j.length&&void 0!==j[2]?j[2]:{},this.db){a.next=5;break}return a.next=4,(0,_db.getDB)();case 4:this.db=a.sent;case 5:if(e=this._getCleanModifier(c),!this._hasHook("updateOne")){a.next=21;break}return a.next=9,this.findOne(b)["catch"](function(a){console.error(a)});case 9:return f=a.sent,this._runBeforeHook("updateOne",f,c,d),a.next=13,this.db.collection(this.collectionName).updateOne(f?{_id:f._id}:b,e,d);case 13:if(g=a.sent,h=f?f._id:g.upsertedId?g.upsertedId._id:null,!this._hasAfterHook("updateOne")){a.next=20;break}return a.next=18,this.findOne({_id:h});case 18:i=a.sent,this._runAfterHook("updateOne",i,c,d);case 20:return a.abrupt("return",g);case 21:return a.abrupt("return",this.db.collection(this.collectionName).updateOne(b,e,d));case 22:case"end":return a.stop();}},a,this)}));return function updateOne(){return a.apply(this,arguments)}}()},{key:"updateMany",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e,f,g=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=2<g.length&&void 0!==g[2]?g[2]:{},this.db){a.next=5;break}return a.next=4,(0,_db.getDB)();case 4:this.db=a.sent;case 5:return this._runBeforeHook("updateMany",b,c,d),e=this._getCleanModifier(c),a.next=9,this.db.collection(this.collectionName).updateMany(b,e,d);case 9:return f=a.sent,this._runAfterHook("updateMany",b,c,d),a.abrupt("return",f);case 12:case"end":return a.stop();}},a,this)}));return function updateMany(){return a.apply(this,arguments)}}()},{key:"update",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=2<e.length&&void 0!==e[2]?e[2]:{},a.abrupt("return",this.updateMany(b,c,d));case 2:case"end":return a.stop();}},a,this)}));return function update(){return a.apply(this,arguments)}}()},{key:"insert",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=1<f.length&&void 0!==f[1]?f[1]:{},this.db){a.next=5;break}return a.next=4,(0,_db.getDB)();case 4:this.db=a.sent;case 5:return this._runBeforeHook("insert",b,c),d=this._getCleanDoc(b),d.hasOwnProperty("_id")||(d._id=Random.id()),a.next=10,this.db.collection(this.collectionName).insertOne(d,c);case 10:return e=a.sent,this._runAfterHook("insert",d,c),a.abrupt("return",e);case 13:case"end":return a.stop();}},a,this)}));return function insert(){return a.apply(this,arguments)}}()},{key:"deleteOne",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.db){a.next=4;break}return a.next=3,(0,_db.getDB)();case 3:this.db=a.sent;case 4:return this._runBeforeHook("deleteOne",b,c),a.next=7,this.db.collection(this.collectionName).deleteOne(b,c);case 7:return d=a.sent,this._runAfterHook("deleteOne",b,c),a.abrupt("return",d);case 10:case"end":return a.stop();}},a,this)}));return function deleteOne(){return a.apply(this,arguments)}}()},{key:"deleteMany",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.db){a.next=4;break}return a.next=3,(0,_db.getDB)();case 3:this.db=a.sent;case 4:return this._runBeforeHook("deleteMany",b,c),a.next=7,this.db.collection(this.collectionName).deleteMany(b,c);case 7:return d=a.sent,this._runAfterHook("deleteMany",b,c),a.abrupt("return",d);case 10:case"end":return a.stop();}},a,this)}));return function deleteMany(){return a.apply(this,arguments)}}()},{key:"before",value:function before(a,b){this._before[a]||(this._before[a]=[]),this._before[a].push(b)}},{key:"after",value:function after(a,b){this._after[a]||(this._after[a]=[]),this._after[a].push(b)}},{key:"_runBeforeHook",value:function _runBeforeHook(a,b,c,d){var e=this;this._hasBeforeHook(a)&&this._before[a].every(function(a){return a.call(e,b,c,d)})}},{key:"_runAfterHook",value:function _runAfterHook(a,b,c,d){var e=this;this._hasAfterHook(a)&&this._after[a].every(function(a){return a.call(e,b,c,d)})}},{key:"_hasHook",value:function _hasHook(a){return this._before.hasOwnProperty(a)||this._after.hasOwnProperty(a)}},{key:"_hasBeforeHook",value:function _hasBeforeHook(a){return this._before.hasOwnProperty(a)}},{key:"_hasAfterHook",value:function _hasAfterHook(a){return this._after.hasOwnProperty(a)}},{key:"_getCleanModifier",value:function _getCleanModifier(a){var b=a;if(this.schema){b=this.schema.clean(a);var c=this.schema.newContext();if(c.validate(b,{modifier:!0}),!c.isValid())throw new Error(c.validationErrors())}return b}},{key:"_getCleanDoc",value:function _getCleanDoc(a){var b=a;return this.schema&&(b=this.schema.clean(a)),b}}]),a}();exports.Collection=Collection;