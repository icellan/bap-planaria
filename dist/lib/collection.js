"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.Collection=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_db=require("./db"),Collection=function(){function a(b){var c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];(0,_classCallCheck2["default"])(this,a),this.collectionName=b,this.schema=c,c&&this.schema.extend({_id:{type:String}}),this._before={},this._after={}}return(0,_createClass2["default"])(a,[{key:"find",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c,d,e=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b=0<e.length&&void 0!==e[0]?e[0]:{},c=1<e.length&&void 0!==e[1]?e[1]:{},this.db){a.next=6;break}return a.next=5,(0,_db.getDB)();case 5:this.db=a.sent;case 6:return a.next=8,this._runBeforeHook("find",b,c);case 8:return a.next=10,this.db.collection(this.collectionName).find(b,c);case 10:return d=a.sent,a.next=13,this._runAfterHook("find",d);case 13:return a.abrupt("return",d);case 14:case"end":return a.stop();}},a,this)}));return function find(){return a.apply(this,arguments)}}()},{key:"findOne",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c,d,e=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b=0<e.length&&void 0!==e[0]?e[0]:{},c=1<e.length&&void 0!==e[1]?e[1]:{},this.db){a.next=6;break}return a.next=5,(0,_db.getDB)();case 5:this.db=a.sent;case 6:return a.next=8,this._runBeforeHook("findOne",b,c);case 8:return a.next=10,this.db.collection(this.collectionName).findOne(b);case 10:return d=a.sent,a.next=13,this._runAfterHook("findOne",d);case 13:return a.abrupt("return",d);case 14:case"end":return a.stop();}},a,this)}));return function findOne(){return a.apply(this,arguments)}}()},{key:"updateOne",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e,f,g,h,i,j=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=2<j.length&&void 0!==j[2]?j[2]:{},this.db){a.next=5;break}return a.next=4,(0,_db.getDB)();case 4:this.db=a.sent;case 5:if(e=this._getCleanModifier(c),!this._hasHook("updateOne")){a.next=23;break}return a.next=9,this.findOne(b)["catch"](function(a){console.error(a)});case 9:return f=a.sent,a.next=12,this._runBeforeHook("updateOne",f,c,d);case 12:return a.next=14,this.db.collection(this.collectionName).updateOne(f?{_id:f._id}:b,e,d);case 14:if(g=a.sent,h=f?f._id:g.upsertedId?g.upsertedId._id:null,!this._hasAfterHook("updateOne")){a.next=22;break}return a.next=19,this.findOne({_id:h});case 19:return i=a.sent,a.next=22,this._runAfterHook("updateOne",i,c,d);case 22:return a.abrupt("return",g);case 23:return a.abrupt("return",this.db.collection(this.collectionName).updateOne(b,e,d));case 24:case"end":return a.stop();}},a,this)}));return function updateOne(){return a.apply(this,arguments)}}()},{key:"updateMany",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e,f,g=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=2<g.length&&void 0!==g[2]?g[2]:{},this.db){a.next=5;break}return a.next=4,(0,_db.getDB)();case 4:this.db=a.sent;case 5:return a.next=7,this._runBeforeHook("updateMany",b,c,d);case 7:return e=this._getCleanModifier(c),a.next=10,this.db.collection(this.collectionName).updateMany(b,e,d);case 10:return f=a.sent,a.next=13,this._runAfterHook("updateMany",b,c,d);case 13:return a.abrupt("return",f);case 14:case"end":return a.stop();}},a,this)}));return function updateMany(){return a.apply(this,arguments)}}()},{key:"update",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=2<e.length&&void 0!==e[2]?e[2]:{},a.abrupt("return",this.updateMany(b,c,d));case 2:case"end":return a.stop();}},a,this)}));return function update(){return a.apply(this,arguments)}}()},{key:"insert",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=1<f.length&&void 0!==f[1]?f[1]:{},this.db){a.next=5;break}return a.next=4,(0,_db.getDB)();case 4:this.db=a.sent;case 5:return a.next=7,this._runBeforeHook("insert",b,c);case 7:return d=this._getCleanDoc(b),d.hasOwnProperty("_id")||(d._id=Random.id()),a.next=11,this.db.collection(this.collectionName).insertOne(d,c);case 11:return e=a.sent,a.next=14,this._runAfterHook("insert",d,c);case 14:return a.abrupt("return",e);case 15:case"end":return a.stop();}},a,this)}));return function insert(){return a.apply(this,arguments)}}()},{key:"deleteOne",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.db){a.next=4;break}return a.next=3,(0,_db.getDB)();case 3:this.db=a.sent;case 4:return a.next=6,this._runBeforeHook("deleteOne",b,c);case 6:return a.next=8,this.db.collection(this.collectionName).deleteOne(b,c);case 8:return d=a.sent,a.next=11,this._runAfterHook("deleteOne",b,c);case 11:return a.abrupt("return",d);case 12:case"end":return a.stop();}},a,this)}));return function deleteOne(){return a.apply(this,arguments)}}()},{key:"deleteMany",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.db){a.next=4;break}return a.next=3,(0,_db.getDB)();case 3:this.db=a.sent;case 4:return a.next=6,this._runBeforeHook("deleteMany",b,c);case 6:return a.next=8,this.db.collection(this.collectionName).deleteMany(b,c);case 8:return d=a.sent,a.next=11,this._runAfterHook("deleteMany",b,c);case 11:return a.abrupt("return",d);case 12:case"end":return a.stop();}},a,this)}));return function deleteMany(){return a.apply(this,arguments)}}()},{key:"before",value:function before(a,b){this._before[a]||(this._before[a]=[]),this._before[a].push(b)}},{key:"after",value:function after(a,b){this._after[a]||(this._after[a]=[]),this._after[a].push(b)}},{key:"_runBeforeHook",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d,e){var f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this._hasBeforeHook(b)){a.next=9;break}f=0;case 2:if(!(f<this._before[b].length)){a.next=9;break}return g=this._before[b][f],a.next=6,g.call(this,c,d,e);case 6:f++,a.next=2;break;case 9:case"end":return a.stop();}},a,this)}));return function _runBeforeHook(){return a.apply(this,arguments)}}()},{key:"_runAfterHook",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d,e){var f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this._hasAfterHook(b)){a.next=9;break}f=0;case 2:if(!(f<this._after[b].length)){a.next=9;break}return g=this._after[b][f],a.next=6,g.call(this,c,d,e);case 6:f++,a.next=2;break;case 9:case"end":return a.stop();}},a,this)}));return function _runAfterHook(){return a.apply(this,arguments)}}()},{key:"_hasHook",value:function _hasHook(a){return this._before.hasOwnProperty(a)||this._after.hasOwnProperty(a)}},{key:"_hasBeforeHook",value:function _hasBeforeHook(a){return this._before.hasOwnProperty(a)}},{key:"_hasAfterHook",value:function _hasAfterHook(a){return this._after.hasOwnProperty(a)}},{key:"_getCleanModifier",value:function _getCleanModifier(a){var b=a;if(this.schema){b=this.schema.clean(a);var c=this.schema.newContext();if(c.validate(b,{modifier:!0}),!c.isValid())throw new Error(c.validationErrors())}return b}},{key:"_getCleanDoc",value:function _getCleanDoc(a){var b=a;return this.schema&&(b=this.schema.clean(a)),b}}]),a}();exports.Collection=Collection;