"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_eventsource=_interopRequireDefault(require("eventsource")),ReconnectingEventSource=function(){function a(b,c){var d=this;(0,_classCallCheck2["default"])(this,a),this._configuration=null==c?null:Object.assign({},c),this._eventSource=null,this._lastEventId=null,this._timer=null,this._listeners={},this.url=b,this.readyState=0,this.max_retry_time=3e3,null!=this._configuration&&(this._configuration.lastEventId&&(this._lastEventId=this._configuration.lastEventId,delete this._configuration.lastEventId),this._configuration.max_retry_time&&(this.max_retry_time=this._configuration.max_retry_time,delete this._configuration.max_retry_time)),this._onevent_wrapped=function(a){d._onevent(a)},this._start()}return(0,_createClass2["default"])(a,[{key:"_start",value:function _start(){var a=this,b=this.url;this._lastEventId&&(b+=-1===b.indexOf("?")?"?":"&",b+="lastEventId="+encodeURIComponent(this._lastEventId)),this._eventSource=new _eventsource["default"](b,this._configuration),this._eventSource.onopen=function(b){a._onopen(b)},this._eventSource.onerror=function(b){a._onerror(b)},this._eventSource.onmessage=function(b){a.onmessage(b)};for(var c,d=0,e=Object.keys(this._listeners);d<e.length;d++)c=e[d],this._eventSource.addEventListener(c,this._onevent_wrapped)}},{key:"_onopen",value:function _onopen(a){0===this.readyState&&(this.readyState=1,this.onopen(a))}},{key:"_onerror",value:function _onerror(a){var b=Math.round;var c=this;if(1===this.readyState&&(this.readyState=0,this.onerror(a)),this._eventSource&&2===this._eventSource.readyState){this._eventSource.close(),this._eventSource=null;var d=b(this.max_retry_time*Math.random());this._timer=setTimeout(function(){return c._start()},d)}}},{key:"_onevent",value:function _onevent(a){a.lastEventId&&(this._lastEventId=a.lastEventId);var b=this._listeners[a.type];if(null!=b)for(var c,d=0,e=(0,_toConsumableArray2["default"])(b);d<e.length;d++)c=e[d],c(a);"message"===a.type&&this.onmessage(a)}},{key:"onopen",value:function onopen(){}},{key:"onerror",value:function onerror(){}},{key:"onmessage",value:function onmessage(){}},{key:"close",value:function close(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._eventSource&&(this._eventSource.close(),this._eventSource=null),this.readyState=2}},{key:"addEventListener",value:function addEventListener(a,b){var c=a.toString();c in this._listeners||(this._listeners[c]=[],this._eventSource&&this._eventSource.addEventListener(c,this._onevent_wrapped));var d=this._listeners[c];d.includes(b)||(this._listeners[c]=[].concat((0,_toConsumableArray2["default"])(d),[b]))}},{key:"removeEventListener",value:function removeEventListener(a,b){var c=a.toString();if(c in this._listeners){var d=this._listeners[c],e=d.filter(function(a){return a!==b});0<e.length?this._listeners[c]=e:(delete this._listeners[c],this._eventSource&&this._eventSource.removeEventListener(c,this._onevent_wrapped))}}}]),a}();exports["default"]=ReconnectingEventSource;