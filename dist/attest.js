"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.handleDataTransaction=exports.handleRevokeTransaction=exports.handleAttestationTransaction=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_id=require("./id"),_attest=require("./schemas/attest"),_bap=require("./bap"),handleAttestationTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f,g,h,i,j,k;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("ATTEST"===b.type){a.next=2;break}return a.abrupt("return");case 2:return a.next=4,(0,_id.getIdForAddress)(b.signatureAddress);case 4:return c=a.sent,a.next=7,(0,_id.wasIdValidForAddressAt)(b.signatureAddress,b.block,c);case 7:if(d=a.sent,!(c&&d)){a.next=36;break}return e=c._id,f={idKey:e,address:b.signatureAddress,txId:b._id,block:b.block,sequence:+b.sequence},b.data&&(f.data=b.data),a.next=14,_attest.Attest.findOne({_id:b.hash});case 14:if(g=a.sent,!g){a.next=32;break}if(i=null===(h=g.signers)||void 0===h?void 0:h.find(function(a){return a.txId===b.txId}),!i){a.next=22;break}return a.next=20,_attest.Attest.update({_id:b.hash,"signers.txId":b._id},{$set:{"signers.$.block":b.block}});case 20:a.next=30;break;case 22:if(k=null===(j=g.signers)||void 0===j?void 0:j.find(function(a){return a.idKey===e}),!k){a.next=28;break}return a.next=26,_attest.Attest.updateOne({_id:b.hash,"signers.idKey":e,"signers.sequence":{$lt:+b.sequence}},{$set:{"signers.$.sequence":+b.sequence},$unset:{"signers.$.revokedId":b._id}});case 26:a.next=30;break;case 28:return a.next=30,_attest.Attest.update({_id:b.hash},{$addToSet:{signers:f}});case 30:a.next=34;break;case 32:return a.next=34,_attest.Attest.insert({_id:b.hash,signers:[f]});case 34:a.next=38;break;case 36:return a.next=38,(0,_bap.addBAPErrorTransaction)({txId:b._id,doc:b,error:"Could not validate attestation",id:c,validAddress:d});case 38:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();exports.handleAttestationTransaction=handleAttestationTransaction;var handleRevokeTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("REVOKE"===b.type){a.next=2;break}return a.abrupt("return");case 2:return a.next=4,(0,_id.getIdForAddress)(b.signatureAddress);case 4:return c=a.sent,a.next=7,(0,_id.wasIdValidForAddressAt)(b.signatureAddress,b.block,c);case 7:if(d=a.sent,!(c&&d)){a.next=16;break}return e=c._id,a.next=12,_attest.Attest.findOne({_id:b.hash});case 12:if(f=a.sent,!f){a.next=16;break}return a.next=16,_attest.Attest.updateOne({_id:b.hash,"signers.idKey":e,"signers.sequence":{$lt:+b.sequence}},{$set:{"signers.$.revokedId":b._id,"signers.$.sequence":+b.sequence}});case 16:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();exports.handleRevokeTransaction=handleRevokeTransaction;var handleDataTransaction=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("DATA"===b.type){a.next=2;break}return a.abrupt("return");case 2:return a.next=4,(0,_id.getIdForAddress)(b.signatureAddress);case 4:return c=a.sent,a.next=7,(0,_id.wasIdValidForAddressAt)(b.signatureAddress,b.block,c);case 7:if(d=a.sent,!(c&&d)){a.next=16;break}return e=c._id,a.next=12,_attest.Attest.findOne({_id:b.hash});case 12:if(f=a.sent,!f){a.next=16;break}return a.next=16,_attest.Attest.updateOne({_id:b.hash,"signers.idKey":e},{$set:{"signers.$.data":b.sequence}});case 16:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();exports.handleDataTransaction=handleDataTransaction;